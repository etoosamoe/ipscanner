# ip-scanner 

**Netbox хранит**:
 - ip-адрес в виде address/prefix (10.1.1.2/24)
 - status: active, deprecated, reserved (актив - используется, депрекейтед - свободен, резервед - занят, но не пингуется. добавлено в ручную)
 - alive: true false (пингуется айпишник или нет)

**База данных хранит**:
 - ip-address: ip-адрес без префикса
 - ip-prefix: префикс адреса
 - ip-address-id: id адреса в нетбоксе
 - last-status: результат последнего пинга True or False
 - last-alive-date: дата последнего успешного пинга
 - last-ping-date: дата последнего пинга
 - notification: отправлялось ли уведомление или нет

### Запуск

- Переименовать .env.example в .env и заполнить переменные
- Иметь готовую таблицу в БД MySQL (нет скрипта)
- Запустить python3 ipscan.py

#### Docker

- Заполнить .env
- Собрать контейнер
- Запустить контейнер

#### GitlabCI

- В пайплайне описана сборка образа(kaniko) при изменениях в файлах с кодом и пуш файлов в приватный регистри

### Логика работы:

В базе данных хранятся все адреса, которые в Нетбоксе имеют статус Active, Deprecated.

1. Скрипт берет список id из Нетбокса которые имеют статус Active, Deprecated
1. Скрипт берет список id и статусов из Базы данных
1. Скрипт сравнивает эти два списка для поиска изменений и вносит соответствующие изменения
    - Примеры изменений:
    - В нетбоксе был адрес Актив, соотв. в базе он присутствуют. Кто-то изменил его статус на Reserved, его надо удалить из базы
    - В нетбоксе был адрес Reserved, в базе его нет. Кто-то изменил его статус на Active или Deprecated, его надо добавить в базу
1. Скрипт берет ip-адреса из базы данных, пингует их в мультипоточном режиме. Количество воркеров указывается в переменной.  
1. Результаты пинга записывает в словарь вида ip-address: True|False  
1. Скрипт обновляет статусы адресов в базе данных согласно словарю из предыдущего этапа
1. Скрипт сравнивает статусы в БД и НБ
    - Если адрес в БД со статусом False более двух дней - формируется отдельный список
    - Если адрес в в НБ со статусом False, но после результатов пинга в БД стал True - формируется отдельный список
1. Скрипт обновляет в Нетбокс параметр alive согласно данным из списков полученных в результате сравнения (чтобы передавались только изменения)
1. Скрипт отправляет уведомление в телеграм о протухании адреса или о воскрешении.

### Логи

Формат логов(пишутся в файл):

```
2021-08-21 06:00:10.402834 NB <--> DB sync started.
2021-08-21 06:00:10.403246 NB <--> DB sync finished.
2021-08-21 06:00:10.403339 Starting ping with 50 workers.
2021-08-21 06:01:15.383916 Ping finished
2021-08-21 06:01:15.387196 Starting DB update
2021-08-21 06:01:15.387250 Current timestamp: 1629525675
2021-08-21 06:01:22.674862 DB update finished
Diff:  {6228: 'False'}
2021-08-21 06:01:24.720059 Updated id: 6228 with {'status': 'deprecated', 'custom_fields': {'alive': False}} - Status code is 200
2021-08-21 06:01:25.075726 Nothing to update
```
---
to-do:
- ~~проверка: если адрес недоступен в течение двух дней - отправить уведомление, поставить метку в столбец notification, перевести адрес в нетбоксе в статус Deprecated~~